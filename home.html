<!DOCTYPE html>
<html>
<head>
    <title>Drug Bag Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        let ambulanceNumber = "";
        let drugBagID = "";

        function setAmbulanceNumber() {
            ambulanceNumber = document.getElementById("ambulanceInput").value;
            if (ambulanceNumber.length === 4) {
                document.getElementById("screen1").style.display = "none";
                document.getElementById("screen2").style.display = "block";
            } else {
                alert("Please enter a valid 4-digit ambulance number.");
            }
        }

        function startScanner() {
            Quagga.init({
                inputStream: { type: "LiveStream", constraints: { facingMode: "environment" } },
                decoder: { readers: ["code_128_reader"] }
            }, function(err) {
                if (!err) {
                    Quagga.start();
                }
            });
            Quagga.onDetected(function(result) {
                drugBagID = result.codeResult.code;
                document.getElementById("screen2").style.display = "none";
                document.getElementById("screen3").style.display = "block";
                document.getElementById("bagID").textContent = drugBagID;
                Quagga.stop();
            });
        }

        function checkAndSubmit(action) {
            fetch('https://script.google.com/macros/s/YOUR_SCRIPT_URL/exec?drugBagID=' + drugBagID)
            .then(response => response.json())
            .then(data => {
                if (data.status === "Out" && action === "out") {
                    alert("Bag is already signed out. Signing it back in first.");
                    submitScan("in", function() {
                        submitScan("out");
                    });
                } else {
                    submitScan(action);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }

        function submitScan(action, callback) {
            fetch('https://script.google.com/macros/s/YOUR_SCRIPT_URL/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: action,
                    ambulanceNumber: ambulanceNumber,
                    drugBagID: drugBagID,
                    status: action === "out" ? "Out" : "In",
                    lastSeen: action === "out" ? ambulanceNumber : "Storage"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Success") {
                    if (callback) {
                        callback();
                    } else {
                        alert("Scan successful!");
                        location.reload();
                    }
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("There was an error with the request. Please try again.");
            });
        }
    </script>
</head>
<body class="container mt-4">
    <div id="screen1">
        <h2>Enter Ambulance Number</h2>
        <input type="text" id="ambulanceInput" class="form-control mb-3" maxlength="4">
        <button onclick="setAmbulanceNumber()" class="btn btn-primary">Start</button>
    </div>
    
    <div id="screen2" style="display:none;">
        <h2>Scan Drug Bag</h2>
        <button onclick="startScanner()" class="btn btn-success">Start Scanner</button>
    </div>
    
    <div id="screen3" style="display:none;">
        <h2>Confirm Action</h2>
        <p>Drug Bag ID: <span id="bagID"></span></p>
        <button onclick="checkAndSubmit('in')" class="btn btn-warning">Book In</button>
        <button onclick="checkAndSubmit('out')" class="btn btn-danger">Book Out</button>
    </div>
</body>
</html>






