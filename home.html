<!DOCTYPE html>
<html>
<head>
    <title>Drug Bag Tracker V2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        let ambulanceNumber = "";
        let drugBagID = "";

        function setAmbulanceNumber() {
            ambulanceNumber = document.getElementById("ambulanceInput").value;
            if (ambulanceNumber.length === 4) {
                document.getElementById("scanSection").style.display = "block";
                document.getElementById("loginSection").style.display = "none";
                startScanner();
            } else {
                alert("Please enter a valid 4-digit ambulance number.");
            }
        }

        function startScanner() {
            Quagga.init({
                inputStream: {
                    type: 'LiveStream',
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: 'environment'
                    }
                },
                decoder: {
                    readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'upc_reader']
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    alert("Error starting scanner");
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                drugBagID = result.codeResult.code;
                document.getElementById('barcodeInput').value = drugBagID;
                stopScanner();
                document.getElementById("actionSection").style.display = "block";
            });
        }

        function stopScanner() {
            Quagga.stop();
        }

        function logScan() {
            let action = document.querySelector('input[name="actionType"]:checked').value;
            let status = action === "out" ? "Out" : "In";
            let lastSeen = action === "out" ? ambulanceNumber : "Storage";
            
            // Disable submit button & show loading message
            document.getElementById("submitBtn").disabled = true;
            document.getElementById("loadingMessage").style.display = "block";

            fetch('https://script.google.com/macros/s/AKfycbwVjQvNOS5XZWHur1JFp92w9mGS8HqEFpnwATmkPbtsBsc_uRCYOeiTts3SZ72bzzfMvg/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    ambulanceNumber: ambulanceNumber,
                    drugBagID: drugBagID,
                    status: status,
                    lastSeen: lastSeen
                }),
                mode: 'no-cors'
            })
            .then(response => {
                console.log("Request sent");
                alert("Data submitted successfully!");
                resetForm();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("There was an error with the request. Please try again.");
            })
            .finally(() => {
                // Re-enable button & hide loading message after request completes
                document.getElementById("submitBtn").disabled = false;
                document.getElementById("loadingMessage").style.display = "none";
            });
        }

        function resetForm() {
            document.getElementById("scanSection").style.display = "none";
            document.getElementById("actionSection").style.display = "none";
            document.getElementById("loginSection").style.display = "block";

            document.getElementById('ambulanceInput').value = '';
            document.getElementById('barcodeInput').value = '';
            document.querySelector('input[name="actionType"][value="out"]').checked = true;

            Quagga.stop();
        }
    </script>
</head>
<body>
    <h2>Drug Bag Tracker V2.5</h2>
    <div id="loginSection">
        <label>Enter Ambulance Number:</label>
        <input type="text" id="ambulanceInput" maxlength="4">
        <button onclick="setAmbulanceNumber()">Start</button>
    </div>
    <div id="scanSection" style="display:none;">
        <h3>Scan Drug Bag</h3>
        <div id="scanner-container" style="width: 100%; height: 300px;"></div>
        <input type="text" id="barcodeInput" placeholder="Scan barcode here" readonly>
        <br>
        <div id="actionSection" style="display:none;">
            <label><input type="radio" name="actionType" value="out" checked> Book Out</label>
            <label><input type="radio" name="actionType" value="in"> Book In</label>
            <br>
            <button id="submitBtn" onclick="logScan()">Submit</button>
            <p id="loadingMessage" style="display:none; color: red;">Please wait...</p>
        </div>
    </div>
</body>
</html>
